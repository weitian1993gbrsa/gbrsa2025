<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Required Elements (RE)</title>

<style>
    :root { --bg:#f5f5f5; --border:#ddd; }
    html, body {
        margin:0; padding:0; height:100%;
        background:var(--bg);
        font-family:Arial, sans-serif;
        overflow:hidden;
    }
    body { display:flex; justify-content:center; }

    .wrapper {
        width:100%; max-width:650px; background:white;
        height:100%; display:flex; flex-direction:column;
        box-shadow:0 0 10px #0003;
    }

    /* HEADER */
    .top-bar {
        display:flex; justify-content:space-between; align-items:center;
        padding:12px 16px; background:white; border-bottom:1px solid var(--border);
    }
    .top-btn {
        padding:10px 20px; border:1px solid #ccc;
        border-radius:4px; background:white; cursor:pointer;
    }
    .submit-btn { background:#007bff; color:white; border:none; }

    .score-values {
        text-align:center; font-size:16px; font-weight:700;
        padding:12px 0; background:white; border-bottom:1px solid var(--border);
    }

    /* Undo + Reset */
    .control-bar {
        display:flex;
        justify-content:space-between;
        padding:16px;
        gap:12px;
        background:white;
    }
    .ctrl-btn {
        flex:1;
        padding:10px 16px;
        border:1px solid #999;
        border-radius:6px;
        background:white;
        font-size:14px;
        cursor:pointer;
    }
    .hidden { opacity:0; visibility:hidden; pointer-events:none; }
    .ctrl-btn:disabled { opacity:.4; pointer-events:none; }

    /* Category Grid */
    #reContainer { flex:1; overflow-y:auto; }
    #reContainer::-webkit-scrollbar { width:0; }

    .re-grid {
        display:grid; grid-template-columns:1fr 1fr 1fr;
        gap:12px; padding:0 16px; max-width:600px; margin:20px auto;
    }

    .re-btn {
        height:120px; border-radius:8px; box-shadow:0 4px 10px #0002;
        color:white; display:flex; justify-content:center; align-items:center;
        flex-direction:column; cursor:pointer; font-size:14px;
    }

    .red { background:#d64545; }
    .green { background:#28c766; }
    .disabled { opacity:.35; pointer-events:none; }

    .value-box {
        text-align:center; font-size:22px; font-weight:700;
    }

    /* Submit overlay */
    #submitOverlay {
        position:fixed; inset:0; background:rgba(255,255,255,0.85);
        display:flex; justify-content:center; align-items:center;
        z-index:9999;
    }
    #submitOverlay.hide { display:none!important; }
</style>

<script defer src="config.js"></script>
<script defer src="app.js"></script>
<script defer src="judge-core.js"></script>
<script defer src="judge-forms.js"></script>

</head>
<body>
<div class="wrapper">

    <!-- HEADER -->
    <div class="top-bar">
        <button class="top-btn" onclick="history.back()">Back</button>
        <h3>Final</h3>
        <button class="top-btn submit-btn" id="btnSubmit">Submit</button>
    </div>

    <!-- Missing RE -->
    <div class="score-values"><span id="reLabel">RE (Missing: 12)</span></div>

    <!-- Undo / Reset -->
    <div class="control-bar">
        <button id="undoBtn" class="ctrl-btn hidden">Undo</button>
        <button id="resetBtn" class="ctrl-btn" disabled>Reset</button>
    </div>

    <!-- RE Category Rows -->
    <div id="reContainer"></div>

</div>

<!-- SUBMIT OVERLAY -->
<div id="submitOverlay" class="hide">
  <div style="background:white; padding:20px 30px; border-radius:12px; border:1px solid #ccc; font-weight:700;">
    Submitting…
  </div>
</div>

<script>
// =======================================
// CATEGORY DEFINITIONS
// =======================================
const CATS = [
  { key:"power",        label:"Power / Gymnastics" },
  { key:"multiples",    label:"Multiples" },
  { key:"manipulation", label:"Rope Manipulation" }
];

const values = { power:0, multiples:0, manipulation:0 };

// ⭐ One-level undo only
let lastAction = null;

const container = document.getElementById("reContainer");

// Build UI
CATS.forEach(cat => {
  container.innerHTML += `
    <div class="re-grid">

        <div class="re-btn red"
             id="btn_${cat.key}_minus"
             data-key="${cat.key}"
             data-add="0.5">
            ${cat.label}<br>+0.5
        </div>

        <div class="value-box">
            <span id="val_${cat.key}">0</span> / 4
        </div>

        <div class="re-btn green"
             id="btn_${cat.key}_plus"
             data-key="${cat.key}"
             data-add="1">
            ${cat.label}<br>+1
        </div>

    </div>
  `;
});

// =======================================
// HELPERS
// =======================================

function completed(v){ return Math.floor(v); }

function updateMissing(){
    const total =
      completed(values.power) +
      completed(values.multiples) +
      completed(values.manipulation); // FIXED TYPO HERE

    document.getElementById("reLabel").textContent =
      "RE (Missing: " + (12 - total) + ")";
}

function updateLocks(key){
    const r = document.getElementById(`btn_${key}_minus`);
    const g = document.getElementById(`btn_${key}_plus`);

    if (values[key] >= 4) {
        r.classList.add("disabled");
        g.classList.add("disabled");
    } else {
        r.classList.remove("disabled");
        g.classList.remove("disabled");
    }
}

// =======================================
// TAP HANDLER — ONE-LEVEL UNDO
// =======================================
document.querySelectorAll(".re-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{

    const key = btn.dataset.key;
    const add = Number(btn.dataset.add);

    const prev = values[key];
    let next = prev + add;
    if (next > 4) next = 4;

    if (next === prev) return;

    // Record one-level undo
    lastAction = { key, prev };

    // Apply change
    values[key] = next;

    document.getElementById(`val_${key}`).textContent =
        next.toFixed(1).replace(/\.0$/, "");

    updateLocks(key);
    updateMissing();

    // Undo shows after ANY tap
    undoBtn.classList.remove("hidden");

    // Reset available
    resetBtn.disabled = false;
  });
});

// =======================================
// UNDO — ONE-LEVEL ONLY
// =======================================
undoBtn.addEventListener("click",()=>{

    if (!lastAction) return;

    const { key, prev } = lastAction;
    values[key] = prev;

    document.getElementById(`val_${key}`).textContent =
        prev.toFixed(1).replace(/\.0$/, "");

    updateLocks(key);
    updateMissing();

    // Clear undo
    lastAction = null;
    undoBtn.classList.add("hidden");

    const allZero =
        values.power===0 &&
        values.multiples===0 &&
        values.manipulation===0;

    resetBtn.disabled = allZero;
});

// =======================================
// RESET BUTTON
// =======================================
resetBtn.addEventListener("click",()=>{

    values.power = 0;
    values.multiples = 0;
    values.manipulation = 0;

    lastAction = null;

    ["power","multiples","manipulation"].forEach(k=>{
        document.getElementById(`val_${k}`).textContent = "0";
        updateLocks(k);
    });

    updateMissing();

    undoBtn.classList.add("hidden");
    resetBtn.disabled = true;
});

// =======================================
// INIT
// =======================================
updateMissing();
["power","multiples","manipulation"].forEach(updateLocks);

btnSubmit.addEventListener("click",()=>{
    submitOverlay.classList.remove("hide");
});
</script>

</body>
</html>
