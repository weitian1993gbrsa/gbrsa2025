<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Difficulty Judge</title>

  <link rel="stylesheet" href="./styles.css"/>
  <script defer src="./config.js"></script>
  <script defer src="./app.js"></script>

  <style>
    body {
      background: #f5f7fb;
      padding: 0;
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
    }

    /* SIMPLE TOP HEADER (NO STICKY) */
    .dj-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
    }

    .btn-back {
      padding: .6rem 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-weight: 600;
    }

    .btn-submit {
      padding: .6rem 1rem;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
    }

    .title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* ==== GRID LAYOUT (IJRU EXACT) ==== */
    .skill-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      width: 100%;
      margin-top: 25px;
    }

    /* ==== BUTTON SIZE (IJRU EXACT) ==== */
    .skill-btn {
      background: #22c55e;
      color: #fff;
      border: none;
      border-radius: 18px;
      font-weight: 700;
      font-size: 1.35rem;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      height: 120px;
      min-height: 120px;
    }

    .skill-btn.blue { background:#2563eb; }
    .skill-btn.purple { background:#7e22ce; }

    .skill-btn small {
      font-size: 1.05rem;
      margin-top: 6px;
    }

    /* TABLET */
    @media (min-width: 600px) {
      .skill-btn {
        height: 140px;
        min-height: 140px;
        font-size: 1.55rem;
      }
      .skill-btn small {
        font-size: 1.25rem;
      }
    }

    /* DESKTOP */
    @media (min-width: 900px) {
      .skill-btn {
        height: 160px;
        min-height: 160px;
        font-size: 1.7rem;
      }
      .skill-btn small {
        font-size: 1.35rem;
      }
    }

    /* UNDO / RESET ROW */
    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }

    .btn-undo {
      background: #fff;
      border: 1px solid #ccc;
      padding: .6rem 1rem;
      border-radius: 10px;
      font-weight: 600;
    }

    .btn-reset {
      background: #dc2626;
      color: #fff;
      border: none;
      padding: .6rem 1rem;
      border-radius: 10px;
      font-weight: 700;
    }

    .total-score {
      font-size: 1.4rem;
      font-weight: 800;
    }

  </style>
</head>

<body>

<header class="dj-header">
  <button class="btn-back" onclick="goBack()">← Back</button>
  <div class="title">Difficulty Judge</div>
  <button class="btn-submit" onclick="submitDifficulty()">Submit</button>
</header>

<main>

  <div class="top-controls">
    <button class="btn-undo" id="btnUndo">Undo</button>
    <div class="total-score">Total Score: <span id="totalScore">0.00</span></div>
    <button class="btn-reset" id="btnReset">Reset</button>
  </div>

  <!-- SKILL BUTTON GRID (IJRU ORDER) -->
  <div class="skill-grid">

    <!-- ROW 1 -->
    <button class="skill-btn" data-level="1">Level 1<br><small id="c1">0</small></button>

    <button class="skill-btn blue" data-level="0.5">Level 0.5<br><small id="c0_5">0</small></button>

    <button class="skill-btn" data-level="4">Level 4<br><small id="c4">0</small></button>

    <!-- ROW 2 -->
    <button class="skill-btn" data-level="2">Level 2<br><small id="c2">0</small></button>

    <button class="skill-btn purple" data-level="7">Level 7<br><small id="c7">0</small></button>

    <button class="skill-btn" data-level="5">Level 5<br><small id="c5">0</small></button>

    <!-- ROW 3 -->
    <button class="skill-btn" data-level="3">Level 3<br><small id="c3">0</small></button>

    <button class="skill-btn purple" data-level="8">Level 8<br><small id="c8">0</small></button>

    <button class="skill-btn" data-level="6">Level 6<br><small id="c6">0</small></button>

  </div>

  <!-- HIDDEN FIELDS for backend -->
  <form id="difficultyForm">
    <input type="hidden" name="ID" id="fID">
    <input type="hidden" name="NAME1" id="fNAME1">
    <input type="hidden" name="NAME2" id="fNAME2">
    <input type="hidden" name="NAME3" id="fNAME3">
    <input type="hidden" name="NAME4" id="fNAME4">
    <input type="hidden" name="TEAM" id="fTEAM">
    <input type="hidden" name="STATE" id="fSTATE">
    <input type="hidden" name="HEAT" id="fHEAT">
    <input type="hidden" name="STATION" id="fSTATION">
    <input type="hidden" name="EVENT" id="fEVENT">
    <input type="hidden" name="DIVISION" id="fDIVISION">

    <input type="hidden" name="TOTAL" id="fTOTAL">
    <input type="hidden" name="_form" value="freestyle_difficulty">
  </form>

</main>

<script>
/* ===================================================================
   URL PARSING → FILL HIDDEN FIELDS
=================================================================== */
const qs = new URLSearchParams(location.search);
const set = (id,val) => { const el = document.querySelector(id); if(el) el.value = val || ""; };

set("#fID", qs.get("id"));
set("#fNAME1", qs.get("name1"));
set("#fNAME2", qs.get("name2"));
set("#fNAME3", qs.get("name3"));
set("#fNAME4", qs.get("name4"));
set("#fTEAM", qs.get("team"));
set("#fSTATE", qs.get("state"));
set("#fHEAT", qs.get("heat"));
set("#fSTATION", qs.get("station"));
set("#fEVENT", qs.get("event"));
set("#fDIVISION", qs.get("division"));

/* ===================================================================
   DIFFICULTY VALUES (IJRU)
=================================================================== */
const diffValues = {
  0.5: 0.12, 1:0.15, 2:0.23, 3:0.34, 4:0.51, 5:0.76, 6:1.14, 7:1.71, 8:2.56
};

let counts = { "0.5":0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0 };
let lastTap = null;

/* ===================================================================
   BUTTON CLICK LOGIC
=================================================================== */
document.querySelectorAll(".skill-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const level = btn.dataset.level;

    counts[level]++;
    lastTap = level;

    document.querySelector("#c" + level.replace(".","_")).textContent = counts[level];

    updateTotal();
  });
});

/* ===================================================================
   UNDO
=================================================================== */
document.querySelector("#btnUndo").addEventListener("click", () => {
  if (!lastTap) return;

  counts[lastTap] = Math.max(0, counts[lastTap] - 1);

  document.querySelector("#c" + lastTap.replace(".","_")).textContent = counts[lastTap];

  lastTap = null;
  updateTotal();
});

/* ===================================================================
   RESET
=================================================================== */
document.querySelector("#btnReset").addEventListener("click", () => {
  for (let k in counts) counts[k] = 0;
  document.querySelectorAll(".skill-btn small").forEach(s => s.textContent = "0");
  lastTap = null;
  updateTotal();
});

/* ===================================================================
   UPDATE SCORE
=================================================================== */
function updateTotal() {
  let sum = 0;
  for (let k in counts) {
    sum += counts[k] * diffValues[k];
  }
  document.querySelector("#totalScore").textContent = sum.toFixed(2);
  document.querySelector("#fTOTAL").value = sum.toFixed(2);
}

/* ===================================================================
   SUBMIT FORM
=================================================================== */
function submitDifficulty() {
  const fd = new FormData(document.querySelector("#difficultyForm"));
  const payload = Object.fromEntries(fd.entries());

  apiPost(payload).then(() => {
    alert("Saved!");
    goBack();
  }).catch(err => {
    alert("Submit failed");
    console.error(err);
  });
}

/* ===================================================================
   BACK BUTTON NAVIGATION
=================================================================== */
function goBack() {
  history.back();
}
</script>

</body>
</html>
