<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Required Elements (RE)</title>

<style>

    /* ⭐ Prevent text highlight & enable instant taps */
    * {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
    }

    :root {
        --bg:#f5f5f5;
        --border:#ddd;
    }

    html, body {
        margin:0; padding:0; height:100%;
        background:var(--bg);
        overflow:hidden;
        font-family:system-ui, Arial, sans-serif;
    }

    body { display:flex; justify-content:center; }

    .wrapper {
        width:100%;
        max-width:650px;
        background:white;
        height:100%;
        display:flex;
        flex-direction:column;
    }

    /* HEADER */
    .top-bar {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px 16px;
        background:white;
        border-bottom:1px solid var(--border);
    }
    .top-btn {
        padding:10px 20px;
        border:1px solid #ccc;
        background:white;
        cursor:pointer;
        border-radius:6px;
    }
    .submit-btn {
        background:#007bff;
        color:white;
        border:none;
    }

    /* Missing Label */
    .score-values {
        text-align:center;
        padding:12px 0;
        font-size:16px;
        font-weight:700;
        background:white;
        border-bottom:1px solid var(--border);
    }

    /* Undo + Reset */
    .control-row {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px 20px;
        background:white;
        border-bottom:1px solid #ddd;
        flex-shrink:0;
    }

    .btn-undo {
        background:#f2b632;
        color:white;
        font-weight:bold;
        padding:14px 30px;
        font-size:18px;
        border:none;
        border-radius:4px;
        cursor:pointer;
    }

    .btn-reset {
        background:#e53935;
        color:white;
        font-weight:bold;
        padding:14px 30px;
        font-size:18px;
        border:none;
        border-radius:4px;
        cursor:pointer;
    }

    .hidden {
        opacity:0;
        pointer-events:none;
        visibility:hidden;
    }

    /* RE GRID */
    #reContainer {
        flex:1;
        overflow-y:auto;
        background:#f5f5f5;
        padding-bottom:40px;
    }
    #reContainer::-webkit-scrollbar { width:0; }

    .re-grid {
        display:grid;
        grid-template-columns:1fr 1fr 1fr;
        gap:20px;
        align-items:center;
        margin:22px auto;
        max-width:600px;
        padding:0 16px;
    }

    .re-btn-half, .re-btn-full {
        height:120px;
        border-radius:10px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        text-align:center;
        line-height:1.2;
        color:white;
        font-size:14px;
        cursor:pointer;
    }

    .re-btn-half { background:#d64545; }
    .re-btn-full { background:#28c766; }

    .disabled {
        opacity:.35;
        pointer-events:none;
    }

    .re-value-box {
        text-align:center;
        font-size:22px;
        font-weight:700;
        display:flex;
        justify-content:center;
        align-items:center;
        gap:6px;
    }

    .slash {
        padding:0 1px;
        font-weight:700;
    }

    /* ======================================
       MIRRORED SUBMIT OVERLAY (from speed-judge)
    ====================================== */
    .overlay {
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(255,255,255,0.85);
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .overlay.hide { display:none !important; }

    .overlay-card {
      background:#fff;
      padding:1.25rem 1.5rem;
      border-radius:16px;
      box-shadow:0 10px 30px #0002;
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:.75rem;
    }

    .overlay-text {
      font-weight:700;
      color:#111827;
    }

    .loading {
      display:flex;
      align-items:center;
      gap:.5rem;
    }

    .loading .dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#9ca3af;
      animation:blink 1s infinite ease-in-out;
    }

    .loading .dot:nth-child(2) { animation-delay:.15s }
    .loading .dot:nth-child(3) { animation-delay:.3s }

    @keyframes blink {
      0%,80%,100% { transform:scale(0); opacity:.3; }
      40% { transform:scale(1); opacity:1; }
    }

    html, body {
       overflow: hidden !important;
       position: fixed !important;
       height: 100%;
       width: 100%;
       margin: 0;
       padding: 0;
    }

</style>

<script defer src="config.js"></script>
<script defer src="app.js"></script>
<script defer src="judge-core.js"></script>
<script defer src="judge-forms.js"></script>

</head>

<body>
<div class="wrapper">

    <!-- HEADER -->
    <div class="top-bar">
        <button class="top-btn" onclick="history.back()">Back</button>
        <h3>Final</h3>
        <button class="top-btn submit-btn" id="btnSubmit">Submit</button>
    </div>

    <!-- RE Missing -->
    <div class="score-values">
        <span id="reLabel">RE (Missing: 12)</span>
    </div>

    <!-- Undo + Reset -->
    <div class="control-row">
        <button id="undoBtn" class="btn-undo hidden">Undo</button>
        <button id="resetBtn" class="btn-reset">Reset</button>
    </div>

    <div id="reContainer"></div>

</div>

<!-- ⭐ MIRRORED SUBMIT OVERLAY -->
<div id="submitOverlay" class="overlay hide">
  <div class="overlay-card">
    <div class="loading">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="overlayText" class="overlay-text">Submitting…</div>
  </div>
</div>

<script>
/* ==============================
   CATEGORY DEFINITIONS
============================== */
const CATS = [
  { key:"power",        label:"Power / Gymnastics" },
  { key:"multiples",    label:"Multiples" },
  { key:"manipulation", label:"Rope Manipulation" }
];

const values = { power:0, multiples:0, manipulation:0 };
let lastAction = null;

/* Build UI */
const container = document.getElementById("reContainer");

CATS.forEach(cat => {
  container.innerHTML += `
    <div class="re-grid">

        <div class="re-btn-half" data-key="${cat.key}" data-type="half">
            ${cat.label}<br>+1/2
        </div>

        <div class="re-value-box">
            <span id="val_${cat.key}" class="re-val">0</span>
            <span class="slash">/</span>
            <span>4</span>
        </div>

        <div class="re-btn-full" data-key="${cat.key}" data-type="full">
            ${cat.label}<br>+1
        </div>

    </div>
  `;
});

/* HELPER FUNCTIONS */
function completed(v){ return Math.floor(v); }

function updateMissing(){
    const total =
        completed(values.power) +
        completed(values.multiples) +
        completed(values.manipulation);

    document.getElementById("reLabel").textContent =
        "RE (Missing: " + (12 - total) + ")";
}

function updateLocks(key){
    const v = values[key];

    const half = document.querySelector(`.re-btn-half[data-key="${key}"]`);
    const full = document.querySelector(`.re-btn-full[data-key="${key}"]`);

    if(v >= 4){
        half.classList.add("disabled");
        full.classList.add("disabled");
    } else {
        half.classList.remove("disabled");
        full.classList.remove("disabled");
    }
}

/* ⭐ HIGH-SENSITIVITY BUTTON HANDLER */
document.querySelectorAll(".re-btn-half, .re-btn-full").forEach(btn=>{
    btn.addEventListener("pointerdown", ()=>{

        const key = btn.dataset.key;
        const add = (btn.dataset.type === "half" ? 0.5 : 1);

        const prev = values[key];
        const next = Math.min(prev + add, 4);

        lastAction = { key, prev };
        values[key] = next;

        document.getElementById(`val_${key}`).textContent =
            next.toFixed(1).replace(/\.0$/,"");

        updateLocks(key);
        updateMissing();

        undoBtn.classList.remove("hidden");

        if (navigator.vibrate) navigator.vibrate([35]);
    }, { passive:true });
});

/* ⭐ UNDO BUTTON */
undoBtn.addEventListener("pointerdown",()=>{

    if(!lastAction) return;

    const { key, prev } = lastAction;

    values[key] = prev;

    document.getElementById(`val_${key}`).textContent =
        prev.toFixed(1).replace(/\.0$/,"");

    updateLocks(key);
    updateMissing();

    lastAction = null;
    undoBtn.classList.add("hidden");

    if (navigator.vibrate) navigator.vibrate([50,30]);
});

/* ⭐ RESET BUTTON */
resetBtn.addEventListener("pointerdown",()=>{

    values.power = 0;
    values.multiples = 0;
    values.manipulation = 0;

    lastAction = null;
    undoBtn.classList.add("hidden");

    ["power","multiples","manipulation"].forEach(k=>{
        document.getElementById(`val_${k}`).textContent = "0";
        updateLocks(k);
    });

    updateMissing();

    if (navigator.vibrate) navigator.vibrate([60]);
});

/* ⭐ CLICK SUBMIT */
const overlay = document.getElementById("submitOverlay");

document.getElementById("btnSubmit").addEventListener("click", ()=>{
    overlay.classList.remove("hide");
    if (navigator.vibrate) navigator.vibrate([80]);
});

/* ==============================
   JudgeCore
============================== */
window.addEventListener("DOMContentLoaded", () => {
  JudgeCore.init({
    judgeType:"re",
    submitButton:document.getElementById("btnSubmit"),

    /* ⭐ MINIMAL PATCH A — Required backend fields added */
    buildScore(){
      const comp =
        completed(values.power) +
        completed(values.multiples) +
        completed(values.manipulation);

      return {
        MISSRE: 12 - comp,

        // Required for backend row consistency
        ID: JudgeCore.current?.ID,
        NAME1: JudgeCore.current?.NAME1,
        NAME2: JudgeCore.current?.NAME2,
        NAME3: JudgeCore.current?.NAME3,
        NAME4: JudgeCore.current?.NAME4,
        TEAM: JudgeCore.current?.TEAM,
        STATE: JudgeCore.current?.STATE,
        EVENT: JudgeCore.current?.EVENT,
        DIVISION: JudgeCore.current?.DIVISION,
        STATION: JudgeCore.current?.STATION
      };
    }
  });
});

/* ⭐ Hide overlay when backend submits */
document.addEventListener("judge:submitted",()=>{
    overlay.classList.add("hide");
});
</script>

</body>
</html>
