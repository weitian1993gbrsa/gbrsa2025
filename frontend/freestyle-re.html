<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Required Elements (RE)</title>

<style>
    :root {
        --bg:#f5f5f5;
        --card:#ffffff;
        --border:#ddd;
        --text:#0b1020;
        --muted:#555;
    }

    html, body {
        margin:0; padding:0; height:100%;
        background:var(--bg);
        overflow:hidden;
        font-family:system-ui, Arial, sans-serif;
    }

    body { display:flex; justify-content:center; }

    .wrapper {
        width:100%;
        max-width:650px;
        background:white;
        height:100%;
        display:flex;
        flex-direction:column;
        box-shadow:0 0 12px rgba(0,0,0,0.15);
    }

    .top-bar {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px 16px;
        background:white;
        border-bottom:1px solid var(--border);
        flex-shrink:0;
    }
    .top-btn {
        padding:10px 20px;
        border:1px solid #ccc;
        background:white;
        cursor:pointer;
    }
    .submit-btn {
        background:#007bff;
        color:white;
        border:none;
    }

    .score-values {
        display:flex;
        justify-content:center;
        padding:12px 0;
        font-size:16px;
        font-weight:700;
        background:white;
        border-bottom:1px solid #ddd;
        flex-shrink:0;
    }

    #reContainer {
        flex:1;
        overflow-y:auto;
        background:#f5f5f5;
        padding-bottom:20px;
    }
    #reContainer::-webkit-scrollbar { width:0; }

    .re-grid {
        display:grid;
        grid-template-columns:1fr 1fr 1fr;
        gap:20px;
        align-items:center;
        margin:22px auto;
        max-width:600px;
        padding:0 16px;
    }

    .re-btn-half {
        background:#d64545;
        color:white;
        height:120px;
        border-radius:6px;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        font-size:14px;
        box-shadow:0 4px 10px #0002;
        cursor:pointer;
        text-align:center;
    }

    .re-btn-full {
        background:#28c766;
        color:white;
        height:120px;
        border-radius:6px;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        font-size:14px;
        box-shadow:0 4px 10px #0002;
        cursor:pointer;
        text-align:center;
    }

    .disabled {
        opacity:.4;
        pointer-events:none;
    }

    .re-value-box {
        text-align:center;
        font-size:22px;
        font-weight:700;
        color:#000;
    }

    #submitOverlay {
        position:fixed;
        inset:0;
        background:rgba(255,255,255,0.85);
        display:flex;
        justify-content:center;
        align-items:center;
        z-index:9999;
    }
    #submitOverlay.hide { display:none!important; }
</style>

<script defer src="config.js"></script>
<script defer src="app.js"></script>
<script defer src="judge-core.js"></script>
<script defer src="judge-forms.js"></script>

</head>

<body>
<div class="wrapper">

    <!-- HEADER -->
    <div class="top-bar">
        <button class="top-btn" onclick="history.back()">Back</button>
        <h3>Final</h3>
        <button class="top-btn submit-btn" id="btnSubmit">Submit</button>
    </div>

    <!-- ⭐ RE Missing Display -->
    <div class="score-values">
        <span id="reLabel">RE (Missing: 12)</span>
    </div>

    <div id="reContainer"></div>

</div>

<!-- SUBMIT OVERLAY -->
<div id="submitOverlay" class="hide">
  <div class="overlay-card">
    <div style="text-align:center;">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div style="margin-top:10px;font-weight:700;">Submitting…</div>
  </div>
</div>

<script>
/* CATEGORIES */
const CATS = [
  { key:"power", label:"Power / Gymnastics" },
  { key:"multiples", label:"Multiples" },
  { key:"manipulation", label:"Rope Manipulation" }
];

const container = document.getElementById("reContainer");

const values = {
  power:0,
  multiples:0,
  manipulation:0
};

CATS.forEach(cat => {
  container.innerHTML += `
    <div class="re-grid">
        <div class="re-btn-half" data-key="${cat.key}" data-type="half">
            ${cat.label}<br>-0.5
        </div>

        <div class="re-value-box">
            <span id="val_${cat.key}">0</span> / 4
        </div>

        <div class="re-btn-full" data-key="${cat.key}" data-type="full">
            ${cat.label}<br>+1
        </div>
    </div>
  `;
});

/* FLOOR LOGIC */
function completed(raw){ return Math.floor(raw); }

/* ⭐ UPDATE MissingRE */
function updateTotal(){
    const comp =
      completed(values.power) +
      completed(values.multiples) +
      completed(values.manipulation);

    const missing = 12 - comp;

    document.getElementById("reLabel").textContent =
      "RE (Missing: " + missing + ")";
}

/* BUTTON LOCKS */
function updateLocks(key){
    const v = values[key];

    const half = document.querySelector(`.re-btn-half[data-key="${key}"]`);
    const full = document.querySelector(`.re-btn-full[data-key="${key}"]`);

    if(v >= 4){
        half.classList.add("disabled");
        full.classList.add("disabled");
        return;
    }

    half.classList.remove("disabled");
    full.classList.remove("disabled");
}

/* BUTTON CLICKS */
document.querySelectorAll(".re-btn-half, .re-btn-full").forEach(btn => {
  btn.addEventListener("click", () => {

    const key = btn.dataset.key;
    const type = btn.dataset.type;

    const add = (type === "half" ? 0.5 : 1);

    values[key] = Math.min(values[key] + add, 4);

    document.getElementById(`val_${key}`).textContent =
        values[key].toFixed(1).replace(/\.0$/, "");

    updateLocks(key);
    updateTotal();

    if(navigator.vibrate) navigator.vibrate([40]);
  });
});

/* INIT */
CATS.forEach(c => updateLocks(c.key));
updateTotal();

/* SUBMIT OVERLAY */
const overlay = document.getElementById("submitOverlay");
document.getElementById("btnSubmit").addEventListener("click", () => {
  overlay.classList.remove("hide");
});

/* ⭐ JUDGE CORE — SEND MISSRE TO BACKEND */
window.addEventListener("DOMContentLoaded", () => {
  JudgeCore.init({
    judgeType: "re",
    submitButton: document.getElementById("btnSubmit"),

    buildScore() {
      const comp =
        completed(values.power) +
        completed(values.multiples) +
        completed(values.manipulation);

      const missing = 12 - comp;

      return {
        MISSRE: missing   // ⭐ Backend receives MISSRE
      };
    }
  });
});

document.addEventListener("judge:submitted", () => {
  overlay.classList.add("hide");
});
</script>

</body>
</html>
