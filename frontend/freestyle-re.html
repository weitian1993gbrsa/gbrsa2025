<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Required Elements (RE)</title>

<style>
  * {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
  }

  :root {
    --bg:#f5f5f5;
    --border:#ddd;
  }

  html, body {
    margin:0;
    padding:0;
    height:100%;
    background:var(--bg);
    overflow:hidden;
    font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    display:flex;
    justify-content:center;
  }

  .wrapper {
    width:100%;
    max-width:650px;
    background:white;
    height:100%;
    display:flex;
    flex-direction:column;
  }

  /* ===== HEADER (MATCH DIFFICULTY) ===== */
  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 16px;
    background:white;
    border-bottom:1px solid var(--border);
    flex-shrink:0;
  }

  .back-btn {
    padding:10px 22px;
    border-radius:0;
    border:1px solid #ccc;
    background:white;
    font-size:16px;
    cursor:pointer;
  }

  .submit-btn {
    padding:10px 22px;
    border-radius:0;
    background:#007bff;
    border:none;
    color:white;
    font-weight:600;
    cursor:pointer;
  }

  .score-values {
    text-align:center;
    padding:12px 0;
    font-size:16px;
    font-weight:700;
    background:white;
    border-bottom:1px solid var(--border);
  }

  .control-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 20px;
    background:white;
    border-bottom:1px solid #ddd;
    flex-shrink:0;
  }

  .btn-undo,
  .btn-reset {
    padding:14px 30px;
    font-size:18px;
    font-weight:bold;
    border-radius:4px;
    border:none;
    cursor:pointer;
    color:white;
  }

  .btn-undo { background:#f2b632; }
  .btn-reset { background:#e53935; }

  .hidden {
    opacity:0;
    pointer-events:none;
    visibility:hidden;
  }

  #reContainer {
    flex:1;
    overflow-y:auto;
    background:#f5f5f5;
    padding-bottom:40px;
  }

  #reContainer::-webkit-scrollbar { width:0; }

  .re-grid {
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:20px;
    align-items:center;
    margin:22px auto;
    max-width:600px;
    padding:0 16px;
  }

  .re-btn-half,
  .re-btn-full {
    height:120px;
    border-radius:10px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    text-align:center;
    line-height:1.2;
    color:white;
    font-size:14px;
    cursor:pointer;
  }

  .re-btn-half { background:#d64545; }
  .re-btn-full { background:#28c766; }

  .disabled {
    opacity:.35;
    pointer-events:none;
  }

  .re-value-box {
    text-align:center;
    font-size:22px;
    font-weight:700;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:6px;
  }

  .slash { font-weight:700; }

  .overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.4);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }

  .overlay.hide { display:none; }

  .overlay-card {
    background:white;
    padding:2rem 3rem;
    border-radius:16px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
  }

  .loading .dot {
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin:0 3px;
    background:#333;
    animation:blink 0.45s infinite;
  }

  .loading .dot:nth-child(2) { animation-delay:.15s; }
  .loading .dot:nth-child(3) { animation-delay:.3s; }

  @keyframes blink {
    0%, 80%, 100% { opacity:0; }
    40% { opacity:1; }
  }
</style>

<script defer src="config.js"></script>
<script defer src="app.js"></script>
<script defer src="judge-core.js"></script>
<script defer src="judge-forms.js"></script>

</head>
<body>

<div class="wrapper">

  <!-- HEADER -->
  <header>
    <button class="back-btn" onclick="goBack()">Back</button>
    <h3>Final</h3>
    <button class="submit-btn" id="btnSubmit">Submit</button>
  </header>

  <div class="score-values">
    <span id="reLabel">RE (Missing: 12)</span>
  </div>

  <div class="control-row">
    <button id="undoBtn" class="btn-undo hidden">Undo</button>
    <button id="resetBtn" class="btn-reset">Reset</button>
  </div>

  <div id="reContainer"></div>

</div>

<div id="submitOverlay" class="overlay hide">
  <div class="overlay-card">
    <div class="loading">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div class="overlay-text">Submittingâ€¦</div>
  </div>
</div>

<script>
const CATS = [
  { key: "power",        label: "Power / Gymnastics" },
  { key: "multiples",    label: "Multiples" },
  { key: "manipulation", label: "Rope Manipulation" }
];

const values = { power: 0, multiples: 0, manipulation: 0 };
let lastAction = null;

const container = document.getElementById("reContainer");

CATS.forEach(cat => {
  container.innerHTML += `
    <div class="re-grid">
      <div class="re-btn-half" data-key="${cat.key}" data-type="half">
        ${cat.label}<br/>+1/2
      </div>

      <div class="re-value-box">
        <span id="val_${cat.key}">0</span>
        <span class="slash">/</span>
        <span>4</span>
      </div>

      <div class="re-btn-full" data-key="${cat.key}" data-type="full">
        ${cat.label}<br/>+1
      </div>
    </div>
  `;
});

function completed(v) { return Math.floor(v); }

function updateMissing() {
  const total =
    completed(values.power) +
    completed(values.multiples) +
    completed(values.manipulation);

  document.getElementById("reLabel").textContent =
    "RE (Missing: " + (12 - total) + ")";
}

function updateLocks(key) {
  const v = values[key];
  const half = document.querySelector(`.re-btn-half[data-key="${key}"]`);
  const full = document.querySelector(`.re-btn-full[data-key="${key}"]`);
  if (v >= 4) { half.classList.add("disabled"); full.classList.add("disabled"); }
  else { half.classList.remove("disabled"); full.classList.remove("disabled"); }
}

const undoBtn = document.getElementById("undoBtn");
const resetBtn = document.getElementById("resetBtn");

document.querySelectorAll(".re-btn-half, .re-btn-full").forEach(btn => {
  btn.addEventListener("pointerdown", () => {
    const key = btn.dataset.key;
    const add = btn.dataset.type === "half" ? 0.5 : 1;
    const prev = values[key];
    values[key] = Math.min(prev + add, 4);
    lastAction = { key, prev };

    document.getElementById("val_" + key).textContent =
      values[key].toFixed(1).replace(/\.0$/, "");

    updateLocks(key);
    updateMissing();
    undoBtn.classList.remove("hidden");
    if (navigator.vibrate) navigator.vibrate([35]);
  }, { passive:true });
});

undoBtn.addEventListener("pointerdown", () => {
  if (!lastAction) return;
  values[lastAction.key] = lastAction.prev;
  document.getElementById("val_" + lastAction.key).textContent =
    lastAction.prev.toFixed(1).replace(/\.0$/, "");
  updateLocks(lastAction.key);
  updateMissing();
  lastAction = null;
  undoBtn.classList.add("hidden");
  if (navigator.vibrate) navigator.vibrate([50,30]);
});

resetBtn.addEventListener("pointerdown", () => {
  values.power = values.multiples = values.manipulation = 0;
  ["power","multiples","manipulation"].forEach(k=>{
    document.getElementById("val_"+k).textContent="0";
    updateLocks(k);
  });
  document.getElementById("reLabel").textContent="RE (Missing: 12)";
  lastAction=null;
  undoBtn.classList.add("hidden");
  if (navigator.vibrate) navigator.vibrate([60]);
});

const overlay = document.getElementById("submitOverlay");
const submitBtn = document.getElementById("btnSubmit");

submitBtn.addEventListener("click", () => overlay.classList.remove("hide"));

window.addEventListener("DOMContentLoaded", () => {
  JudgeCore.init({
    judgeType:"re",
    submitButton:submitBtn,
    buildScore(){
      const total =
        completed(values.power) +
        completed(values.multiples) +
        completed(values.manipulation);
      return { MISSRE: 12 - total };
    }
  });
});

document.addEventListener("judge:submitted", () => overlay.classList.add("hide"));

function goBack() {
  const p = new URLSearchParams(location.search);
  location.href =
    `freestyle-station.html?station=${p.get("station")}&key=${p.get("key")}&judgeType=re`;
}
</script>

</body>
</html>
