<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Speed</title>

  <link rel="stylesheet" href="./styles.css"/>
  <script defer src="./app.js"></script>
  <script defer src="./config.js"></script>
  <script defer src="./speed.js"></script>
  <script defer src="./nozoom.js"></script>

<style>#entryIdInput{text-transform:uppercase;}</style>

<!-- iOS anti-zoom -->
<script>
(function(){
  function ensureSize(el){
    try{ if(!el) return;
      var t=el.tagName.toLowerCase();
      if(t==='input' || t==='textarea' || t==='select'){
        el.style.fontSize='16px';
        el.style.webkitTextSizeAdjust='100%';
      }
    }catch(e){}
  }
  document.addEventListener('focusin', e => ensureSize(e.target), true);
  document.addEventListener('focusout', e => { try{
    e.target.style.fontSize=''; e.target.style.webkitTextSizeAdjust='';
  }catch(_){ }}, true);
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  /* Hide QR camera UI */
  #btnOpenCamera { display: none !important; }
  #cameraWrap { display: none !important; }

  .scan-row { display: flex; gap: .75rem; align-items: center; }
  .scan-row .input { flex: 1; }

  .refresh-btn { margin-left: auto; padding: .5rem .9rem; border-radius: .6rem;
    border: 1px solid rgba(0,0,0,.1); background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
  .refresh-btn:active { transform: translateY(1px); }

  /* Header button style */
  .btn.small {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
  }
</style>

</head>

<body class="page">

<!-- ðŸ”¥ REBUILT HEADER -->
<header class="topbar"
  style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;">

  <!-- LEFT: Logo + Title -->
  <div style="display:flex;align-items:center;gap:12px;">
    <img src="./assets/company-logo.png" alt="GBRSA" class="logo" style="height:38px;">
    <h1 style="font-size:20px;margin:0;">Speed</h1>
  </div>

  <!-- RIGHT: Home + Refresh -->
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="btn small" onclick="location.href='admin.html'">Home</button>
    <button id="btnRefresh" class="btn small refresh-btn">Refresh</button>
  </div>

</header>
<!-- END HEADER -->

<main class="container">
  
  <!-- Step 1 -->
  <section class="block">
    <h2>Step 1 â€” Identify Participant</h2>

    <div class="scan-row">
      <button id="btnOpenCamera" class="btn">ðŸ“· Scan QR</button>

      <input id="entryIdInput" class="input"
        placeholder="Type ID HERE ðŸ™ðŸ»" inputmode="text"
        autocapitalize="characters" spellcheck="false">

      <button id="btnLookup" class="btn">Search ID</button>
    </div>

    <div id="cameraWrap" class="camera hide">
      <video id="cam" playsinline autoplay muted></video>
      <div class="scan-tip">Point your rear camera at the QR</div>
    </div>

    <div class="hint">After type ID and then click Search ID.</div>
  </section>

  <!-- Participant Card -->
  <section id="participantCard" class="block hide">
    <div class="row space">
      <h2>Participant</h2>
      <div class="badges">
        <span id="badgeHeat" class="badge">HEAT â€”</span>
        <span id="badgeStation" class="badge">STATION â€”</span>
        <span id="badgeEvent" class="badge">EVENT â€”</span>
        <span id="badgeDivision" class="badge">DIVISION â€”</span>
      </div>
    </div>

    <dl class="info">
      <div><dt>ID</dt><dd id="pId">â€”</dd></div>
      <div><dt>Names</dt><dd id="pNames">â€”</dd></div>
      <div><dt>Team</dt><dd id="pRep">â€”</dd></div>
      <div><dt>State</dt><dd id="pState">â€”</dd></div>
    </dl>

    <button id="btnConfirm" class="btn primary" disabled>
      Confirm & Start Scoring
    </button>
  </section>

  <!-- Step 2 â€” Score Form -->
  <section id="scoreFormWrap" class="block hide">
    <h2>Step 2 â€” Enter Score</h2>

    <form id="scoreForm" class="form">
      <div class="grid">
        <label class="field">
          <span>SCORE</span>
          <input name="SCORE" type="number" required min="0"
            class="input" placeholder="e.g. 156">
        </label>

        <label class="check">
          <input type="checkbox" name="FALSE START">
          <span>FALSE START</span>
        </label>

        <label class="field col-span-2">
          <span>REMARK</span>
          <input name="REMARK" class="input" placeholder="Optional notes">
        </label>
      </div>

      <!-- Hidden values -->
      <input type="hidden" name="ID" id="fId"/>
      <input type="hidden" name="NAME1" id="fNAME1"/>
      <input type="hidden" name="NAME2" id="fNAME2"/>
      <input type="hidden" name="NAME3" id="fNAME3"/>
      <input type="hidden" name="NAME4" id="fNAME4"/>
      <input type="hidden" name="TEAM" id="fREP"/>
      <input type="hidden" name="STATE" id="fSTATE"/>
      <input type="hidden" name="HEAT" id="fHEAT"/>
      <input type="hidden" name="STATION" id="fSTATION"/>
      <input type="hidden" name="EVENT" id="fEVENT"/>
      <input type="hidden" name="DIVISION" id="fDIVISION"/>

      <div class="row space">
        <button type="submit" class="btn primary">Submit Result</button>
      </div>
    </form>
  </section>

</main>

<!-- Submit overlay -->
<div id="submitOverlay" class="overlay hide" aria-live="polite">
  <div class="overlay-card">
    <div class="loading">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="overlayText" class="overlay-text">Sendingâ€¦</div>
  </div>
</div>

<script>judging = true;</script>

<script>
(function iosHelpersInit(){
  try{
    async function hardRefresh(){
      try{
        if (navigator.serviceWorker){
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs){ await r.unregister().catch(()=>{}); }
        }
        if (window.caches){
          const keys = await caches.keys();
          for (const k of keys){ await caches.delete(k).catch(()=>{}); }
        }
      }catch(_){}
      location.reload(true);
    }

    window.hardRefresh = hardRefresh;

    var btnRefresh = document.getElementById('btnRefresh');
    if (btnRefresh){ btnRefresh.addEventListener('click', hardRefresh); }

    var entryInput = document.getElementById('entryIdInput');
    var btnLookup = document.getElementById('btnLookup');

    if (btnLookup && entryInput){
      btnLookup.addEventListener('click', function(){
        var evt = new KeyboardEvent('keyup', {key:'Enter', bubbles:true});
        entryInput.dispatchEvent(evt);
      });
    }

  }catch(e){}
})();
</script>

</body>
</html>
