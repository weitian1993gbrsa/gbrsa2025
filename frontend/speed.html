<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Speed</title>

  <link rel="stylesheet" href="./styles.css"/>
  <script defer src="./app.js"></script>
  <script defer src="./config.js"></script>
  <script defer src="./speed.js"></script>
  <script defer src="./nozoom.js"></script>

<style>#entryIdInput{text-transform:uppercase;}</style>

<!-- iOS anti-zoom -->
<script>
(function(){
  function ensureSize(el){
    try{ if(!el) return;
      var t=el.tagName.toLowerCase();
      if(t==='input' || t==='textarea' || t==='select'){
        el.style.fontSize='16px';
        el.style.webkitTextSizeAdjust='100%';
      }
    }catch(e){}
  }
  document.addEventListener('focusin', e => ensureSize(e.target), true);
  document.addEventListener('focusout', e => { 
    try{
      e.target.style.fontSize=''; 
      e.target.style.webkitTextSizeAdjust='';
    }catch(_){}
  }, true);
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  /* Hide QR camera UI */
  #btnOpenCamera { display: none !important; }
  #cameraWrap { display: none !important; }

  .scan-row { display: flex; gap: .75rem; align-items: center; }
  .scan-row .input { flex: 1; }

  .refresh-btn { 
    margin-left: auto; 
    padding: .5rem .9rem; 
    border-radius: .6rem;
    border: 1px solid rgba(0,0,0,.1); 
    background: #fff; 
    box-shadow: 0 1px 2px rgba(0,0,0,.06); 
  }

  .btn.small {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
  }

  /* NEW PARTICIPANT CARD STYLE */
  .participant-card {
    background: #fff;
    border-radius: 14px;
    padding: 18px 20px;
    margin: 16px 0;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  }
  .pc-line1 {
    font-size: 1.05rem;
    font-weight: 600;
    display: flex;
    gap: 8px;
  }
  .pc-id { color: #444; }
  .pc-name { color: #111; font-weight: 700; }

  .pc-line2,
  .pc-line3 {
    margin-top: 6px;
    font-size: 0.92rem;
    color: #666;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .pc-meta { color: #444; }

  .pc-status {
    margin-top: 12px;
    font-weight: 600;
    font-size: 0.95rem;
  }
  .pc-pending { color: #d97706; } /* orange */
  .pc-done { color: #059669; }     /* green */

  .pc-btn {
    width: 100%;
    margin-top: 16px;
    padding: 0.9rem;
    font-size: 1.05rem;
    border-radius: 10px;
  }
</style>

</head>

<body class="page">

<!-- HEADER -->
<header class="topbar"
  style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;">

  <div style="display:flex;align-items:center;gap:12px;">
    <img src="./assets/company-logo.png" alt="GBRSA" class="logo" style="height:38px;">
    <h1 style="font-size:20px;margin:0;">Speed</h1>
  </div>

  <div style="display:flex;align-items:center;gap:10px;">
    <button class="btn small" onclick="location.href='admin.html'">Home</button>
    <button id="btnRefresh" class="btn small refresh-btn">Refresh</button>
  </div>

</header>

<main class="container">
  
  <!-- Step 1 -->
  <section class="block">
    <h2>Step 1 ‚Äî Identify Participant</h2>

    <div class="scan-row">
      <button id="btnOpenCamera" class="btn">üì∑ Scan QR</button>

      <input id="entryIdInput" class="input"
        placeholder="Type ID HERE üôèüèª" inputmode="text"
        autocapitalize="characters" spellcheck="false">

      <button id="btnLookup" class="btn">Search ID</button>
    </div>

    <div id="cameraWrap" class="camera hide">
      <video id="cam" playsinline autoplay muted></video>
      <div class="scan-tip">Point your rear camera at the QR</div>
    </div>

    <div class="hint">After type ID and then click Search ID.</div>
  </section>

  <!-- NEW PARTICIPANT CARD -->
  <section id="participantCard" class="participant-card hide">

    <div class="pc-line1">
      <span id="pcID" class="pc-id">ID ‚Äî</span>
      <span id="pcName" class="pc-name">NAME ‚Äî</span>
    </div>

    <div class="pc-line2">
      <span id="pcHeat" class="pc-meta">Heat ‚Äî</span>
      <span id="pcTeam" class="pc-meta">Team ‚Äî</span>
      <span id="pcStation" class="pc-meta">Station ‚Äî</span>
    </div>

    <div class="pc-line3">
      <span id="pcState" class="pc-meta">State ‚Äî</span>
      <span id="pcEvent" class="pc-meta">Event ‚Äî</span>
      <span id="pcDivision" class="pc-meta">Division ‚Äî</span>
    </div>

    <div id="pcStatus" class="pc-status pc-pending">‚óè Pending</div>

  </section>

  <!-- Step 2 -->
  <section id="scoreFormWrap" class="block hide">
    <h2>Step 2 ‚Äî Enter Score</h2>

    <form id="scoreForm" class="form">
      <div class="grid">
        <label class="field">
          <span>SCORE</span>
          <input name="SCORE" type="number" required min="0"
            class="input" placeholder="e.g. 156">
        </label>

        <label class="check">
          <input type="checkbox" name="FALSE START">
          <span>FALSE START</span>
        </label>

        <label class="field col-span-2">
          <span>REMARK</span>
          <input name="REMARK" class="input" placeholder="Optional notes">
        </label>
      </div>

      <!-- Hidden values -->
      <input type="hidden" name="ID" id="fId"/>
      <input type="hidden" name="NAME1" id="fNAME1"/>
      <input type="hidden" name="NAME2" id="fNAME2"/>
      <input type="hidden" name="NAME3" id="fNAME3"/>
      <input type="hidden" name="NAME4" id="fNAME4"/>
      <input type="hidden" name="TEAM" id="fREP"/>
      <input type="hidden" name="STATE" id="fSTATE"/>
      <input type="hidden" name="HEAT" id="fHEAT"/>
      <input type="hidden" name="STATION" id="fSTATION"/>
      <input type="hidden" name="EVENT" id="fEVENT"/>
      <input type="hidden" name="DIVISION" id="fDIVISION"/>

      <div class="row space">
        <button type="submit" class="btn primary">Submit Result</button>
      </div>
    </form>
  </section>

</main>

<!-- Submit overlay -->
<div id="submitOverlay" class="overlay hide" aria-live="polite">
  <div class="overlay-card">
    <div class="loading">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="overlayText" class="overlay-text">Sending‚Ä¶</div>
  </div>
</div>

<script>judging = true;</script>

<!-- iOS + Refresh Handling -->
<script>
(function iosHelpersInit(){
  try{
    async function hardRefresh(){
      try{
        if (navigator.serviceWorker){
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs){ await r.unregister().catch(()=>{}); }
        }
        if (window.caches){
          const keys = await caches.keys();
          for (const k of keys){ await caches.delete(k).catch(()=>{}); }
        }
      }catch(_){}
      location.reload(true);
    }

    window.hardRefresh = hardRefresh;

    var btnRefresh = document.getElementById('btnRefresh');
    if (btnRefresh){ btnRefresh.addEventListener('click', hardRefresh); }

    var entryInput = document.getElementById('entryIdInput');
    var btnLookup = document.getElementById('btnLookup');

    if (btnLookup && entryInput){
      btnLookup.addEventListener('click', function(){
        var evt = new KeyboardEvent('keyup', {key:'Enter', bubbles:true});
        entryInput.dispatchEvent(evt);
      });
    }

  }catch(e){}
})();
</script>

</body>
</html>
